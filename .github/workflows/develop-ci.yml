name: Develop CI

on:
  push:
    branches:
      - develop

# on:
#   pull_request:
#     types:
#       - closed
#     branches:
#       - develop

jobs:

  build:
    # if: startsWith(github.head_ref, 'feature/')
    runs-on: ubuntu-latest
    outputs:
      deployment-matrix: ${{ steps.export-deployment-matrix.outputs.deployment-matrix }}
    steps:
      - name: Export deployment matrix
        id: export-deployment-matrix
        run: |
          JSON="$(cat ./deployment-config.json)"
          JSON="${JSON//'%'/'%25'}"
          JSON="${JSON//$'\n'/'%0A'}"
          JSON="${JSON//$'\r'/'%0D'}"
          echo "::set-output name=deployment-matrix::$JSON"
          
      - name: Run a one-line script
        run: |
          echo make build here! ${{ github.ref_name }}
          echo "${{ github.head_ref }}"
    

  deploy:
    # if: startsWith(github.head_ref, 'feature/')
    runs-on: ubuntu-latest
    environment: 
      name: develop
      url: '${{ matrix.server.url }}'
    needs: build
    strategy:
      matrix:
        server: ${{ fromJson(needs.build.outputs.deployment-matrix) }}

    steps:
      - name: "${{ matrix.server.name }}: Prepare deploy"
        run: |
          echo "${{ matrix.server.name }}"

      - name: Set ENV Credentials
        run: |
          client_code=AWS_CREDENTIALS_${{ matrix.server.name }}
          echo "::set-output name=secret::${client_code}"
        id: data

      - name: Serverless deploy
        run: |
          echo name: ${{steps.data.outputs.secret}}
          secret="${{ secrets[steps.data.outputs.secret] }}"
          AWS_ACCESS_KEY_ID=$(echo "$secret" | sed -n '1p')
          AWS_SECRET_ACCESS_KEY=$(echo "$secret" | sed -n '2p')
          echo "key aws: $AWS_ACCESS_KEY_ID"
          echo "secret aws: $AWS_SECRET_ACCESS_KEY"
                 
